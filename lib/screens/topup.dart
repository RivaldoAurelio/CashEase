import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:intl/intl.dart';
import 'passwordScreen.dart';
import '../services/firestore_service.dart';
import '../services/notification_service.dart'; // [RESTORE] Import ini

class TopUpPage extends StatefulWidget {
  final int currentBalance;
  final String phoneNumber;

  const TopUpPage({
    super.key,
    required this.currentBalance,
    required this.phoneNumber,
  });

  @override
  State<TopUpPage> createState() => _TopUpPageState();
}

class _TopUpPageState extends State<TopUpPage> {
  final FirestoreService _firestoreService = FirestoreService();
  final NotificationService _notificationService = NotificationService(); // [RESTORE]

  final List<Map<String, dynamic>> _banks = [
    {'name': 'BCA', 'logo': 'asset/elogo1.png'},
    {'name': 'Mandiri', 'logo': 'asset/elogo2.png'},
    {'name': 'BNI', 'logo': 'asset/elogo5.png'},
    {'name': 'Permata Bank', 'logo': 'asset/elogo3.png'},
  ];

  int? _selectedBankIndex;
  final TextEditingController _amountController = TextEditingController();
  final formatter = NumberFormat.decimalPattern('id_ID');

  @override
  void dispose() {
    _amountController.dispose();
    super.dispose();
  }

  void _showSnackBar(String message, {bool isError = false}) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: isError ? Colors.red : Colors.green,
        duration: const Duration(seconds: 2),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        iconTheme: const IconThemeData(color: Colors.white),
        title: const Text('Isi Saldo', style: TextStyle(color: Colors.white)),
        backgroundColor: Colors.deepPurple,
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              'Dari Bank',
              style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 10),
            Wrap(
              spacing: 10,
              runSpacing: 10,
              children: List.generate(_banks.length, (index) {
                final bank = _banks[index];
                final isSelected = index == _selectedBankIndex;
                return ChoiceChip(
                  label: Text(bank['name']),
                  avatar: Image.asset(bank['logo'], width: 24, height: 24),
                  selected: isSelected,
                  selectedColor: Colors.deepPurple.shade100,
                  onSelected: (_) => setState(() => _selectedBankIndex = index),
                );
              }),
            ),
            const SizedBox(height: 30),
            const Text(
              'Jumlah Top Up',
              style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 10),
            TextField(
              controller: _amountController,
              keyboardType: TextInputType.number,
              inputFormatters: [
                FilteringTextInputFormatter.digitsOnly,
                ThousandsFormatter(formatter),
              ],
              decoration: const InputDecoration(
                hintText: 'Masukkan nominal (cth: 100000)',
                prefixText: 'Rp ',
                border: OutlineInputBorder(),
              ),
            ),
            const SizedBox(height: 30),
            Center(
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.deepPurple,
                  padding: const EdgeInsets.symmetric(
                    horizontal: 40,
                    vertical: 14,
                  ),
                ),
                onPressed: () async {
                  final cleaned = _amountController.text
                      .replaceAll('.', '')
                      .replaceAll(',', '');
                  final int? amount = int.tryParse(cleaned);

                  if (_selectedBankIndex == null) {
                    _showSnackBar('Silakan pilih bank', isError: true);
                  } else if (amount == null || amount <= 0) {
                    _showSnackBar('Masukkan jumlah yang valid', isError: true);
                  } else {
                    final pinVerified = await Navigator.push<bool>(
                      context,
                      MaterialPageRoute(
                        builder:
                            (_) =>
                                PasswordScreen(phoneNumber: widget.phoneNumber),
                      ),
                    );

                    if (pinVerified == true) {
                      final success = await _firestoreService.addTransaction(
                        userPhone: widget.phoneNumber,
                        type: 'topup',
                        amount: amount,
                        description: 'Top up via ${_banks[_selectedBankIndex!]['name']}',
                      );

                      if (success) {
                        // [RESTORE] Tampilkan Notifikasi Lokal
                        _notificationService.showLocalNotification(
                          title: 'Top Up Berhasil! ðŸ’°',
                          body: 'Saldo Rp ${formatter.format(amount)} telah ditambahkan.',
                        ).catchError((e) => print("Notif error: $e"));
                        
                        if (!mounted) return;
                        _showSnackBar('Top Up Berhasil!');
                        
                        Future.delayed(const Duration(milliseconds: 300), () {
                           if (mounted) {
                             Navigator.pop(context, true);
                           }
                        });
                      } else {
                        if (!mounted) return;
                         _showSnackBar('Gagal memproses Top Up', isError: true);
                      }
                    } else {
                      if(mounted) {
                        _showSnackBar('Verifikasi PIN dibatalkan', isError: true);
                      }
                    }
                  }
                },
                child: const Text(
                  'Isi Sekarang',
                  style: TextStyle(fontSize: 16, color: Colors.white),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class ThousandsFormatter extends TextInputFormatter {
  final NumberFormat formatter;
  ThousandsFormatter(this.formatter);

  @override
  TextEditingValue formatEditUpdate(
    TextEditingValue oldValue,
    TextEditingValue newValue,
  ) {
    final cleanText = newValue.text.replaceAll(RegExp(r'[.,]'), '');
    if (cleanText.isEmpty) return newValue;

    final int? number = int.tryParse(cleanText);
    if (number == null) return oldValue;

    final newFormatted = formatter.format(number);
    return TextEditingValue(
      text: newFormatted,
      selection: TextSelection.collapsed(offset: newFormatted.length),
    );
  }
}